FROM jupyter/datascience-notebook

WORKDIR /workdir

COPY ./installers /workdir/models

ENV MODELS_DIR=/workdir/models
ENV MODELS_CPT_MODEL=CPT
ENV MODELS_CPT_VERSION=17.6.1
ENV MODELS_CPT_SOURCE=${MODELS_CPT_MODEL}.${MODELS_CPT_VERSION}.tar.gz
ENV MODELS_CPT_DIR=${MODELS_DIR}/${MODELS_CPT_MODEL}
ENV CPT_BIN_DIR=${MODELS_CPT_DIR}/${MODELS_CPT_VERSION}/bin
ENV PYCPT_SCRIPTS_DIR=${MODELS_DIR}/PyCPT

ENV PATH="${CPT_BIN_DIR}:${PATH}"
ENV CONDA_ENV_PYCPT=envpycpt
ENV PATH /root/anaconda3/bin:$PATH

# Install dependencies
# Climate analysis tools: libnetcdf-dev libgrib-api-dev grads cdo nco
USER root
RUN apt-get clean \
    && apt-get update \
    && apt-get install -y \
    libnetcdf-dev \
    grads \
    cdo \
    nco \
    make \
    gcc \ 
    vim \
    unzip \
    dirmngr \
    software-properties-common \
    apt-transport-https \
    cmake \
    gfortran \
    git \
    wget 

RUN wget https://repo.anaconda.com/archive/Anaconda3-2021.11-Linux-x86_64.sh \
    && mkdir ~/Anaconda3-2021.11 \
    && mv Anaconda3-2021.11-Linux-x86_64.sh ~/Anaconda3-2021.11 \
    && cd ~/Anaconda3-2021.11 \
    && chmod +x Anaconda3-2021.11-Linux-x86_64.sh \
    && bash Anaconda3-2021.11-Linux-x86_64.sh -b \
    && cp ${MODELS_DIR}/.bashrc ~/.bashrc \
    && /bin/bash -c "source ~/.bashrc" \
    #Installing Anaconda and Python dependencies on a conda enviroment
    && printf "y" | conda create -n ${CONDA_ENV_PYCPT} xarray scipy cartopy netcdf4 numpy scikit-learn rasterio geopandas

# CPT and PyCPT scripts
RUN cd ${MODELS_DIR} \ 
    && mkdir -p /${MODELS_CPT_MODEL}/${MODELS_CPT_VERSION} \
    && tar xzvf ${MODELS_CPT_SOURCE} \
    && cd ${MODELS_CPT_DIR}/${MODELS_CPT_VERSION} \
    && make distclean \
    && make \
    && make ${MODELS_CPT_DIR}/${MODELS_CPT_VERSION}=~ install \
    && cd ${MODELS_DIR} \
    && mkdir ${PYCPT_SCRIPTS_DIR} \
    && cd ${PYCPT_SCRIPTS_DIR} \
    && git clone https://bitbucket.org/py-iri/iri-pycpt.git 

# Observations:
# CPT.17.6.1
# GNU Fortran (Debian 8.3.0-6) 8.3.0
# Anaconda3-2021.11-Linux
# PyCPT (last commit on master branch at 13/01/2022)
# CPT, Gfortran, Anaconda and PyCPT are the last versions used a this date (01/02/2022)
# Docs: https://bitbucket.org/py-iri/iri-pycpt/wiki/PyCPT%20Detailed%20Instructions

# docker build -t deguzman98/pycpt_jupyter:latest .
# docker tag 0a1002a8a03d deguzman98/pycpt_jupyter:latest

# docker run -it --rm -v D:/CIAT/Code/USAID/usaid_forecast_docker/forecast_process/workdir:/forecast/workdir stevensotelo/aclimate_process:latest /bin/bash 
# docker run -it --rm -e N_CORES=2 -v D:/CIAT/Code/USAID/usaid_forecast_docker/forecast_process/workdir:/forecast/workdir stevensotelo/aclimate_process:2.0 /bin/bash
# docker run -it --rm -e N_CORES=5 --cpus="5" --mount type=bind,source=/opt/aclimate/1.Data/forecast/202110,destination=/forecast/workdir stevensotelo/aclimate_process:latest /bin/bash